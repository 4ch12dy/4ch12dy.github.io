<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Mach vm*API | 4chendy</title>
  <meta name="author" content="4chendy">
  
  <meta name="description" content="exec函数流程
mach_vm_*
mach_vm_cllocate
1mach_vm_allocate(vm_map_t map,mach_vm_address_t  *address,mach_vm_size_t size,int flags);


在map中分配size个字节大小的内存，根">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Mach vm*API"/>
  <meta property="og:site_name" content="4chendy"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="4chendy" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script>
  $(document).ready(function() {
    $('#sidebar').delay(400).animate({ width: '285px' }, 500, function() {
      $('.personal-info').css({display: 'table'}).hide().fadeIn(500);
    });
  });
  </script>
  
</head>


<body>
  <header id="header" class="inner"><!-- <div class="alignleft">
  <h1><a href="/">4chendy</a></h1>
  <h2><a href="/"></a></h2>
</div>
 --><!-- <nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
 --></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignright"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2017-03-04T17:51:44.000Z"><a href="/2017/03/05/Mach vm*API/exec函数流程/">2017-03-05</a></time>
      
      
  
    <h1 class="depth title">Mach vm*API</h1>
  

    </header>
    <div class="entry depth">
      
        <h2 id="exec函数流程"><a href="#exec函数流程" class="headerlink" title="exec函数流程"></a>exec函数流程</h2><p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/f10c5443276635863d7ac7aea6fa2e6db76ce2c3/png/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.png" alt="exec函数流程"></p>
<h2 id="mach-vm"><a href="#mach-vm" class="headerlink" title="mach_vm_*"></a><code>mach_vm_*</code></h2><ul>
<li><p>mach_vm_cllocate</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mach_vm_allocate(<span class="keyword">vm_map_t</span> <span class="built_in">map</span>,<span class="keyword">mach_vm_address_t</span>  *address,<span class="keyword">mach_vm_size_t</span> size,<span class="keyword">int</span> flags);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>在map中分配size个字节大小的内存，根据flags的不同会有不同的处理方式。address是一个I/O的参数（例如：获取分配后的内存大小）。如果flags的值不是<code>VM_FLAGS_ANYWHERE</code>，那么内存将被分配到address指向的地址。</p>
<ul>
<li>mach_vm_region<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span></div><div class="line">mach_vm_region(</div><div class="line">	<span class="keyword">vm_map_t</span>		 <span class="built_in">map</span>,</div><div class="line">	<span class="keyword">mach_vm_offset_t</span>	*address,		<span class="comment">/* IN/OUT */</span></div><div class="line">	<span class="keyword">mach_vm_size_t</span>	*size,			<span class="comment">/* OUT */</span></div><div class="line">	<span class="keyword">vm_region_flavor_t</span>	 flavor,		<span class="comment">/* IN */</span></div><div class="line">	<span class="keyword">vm_region_info_t</span>	 info,			<span class="comment">/* OUT */</span></div><div class="line">	<span class="keyword">mach_msg_type_number_t</span>	*count,			<span class="comment">/* IN/OUT */</span></div><div class="line">	<span class="keyword">mach_port_t</span>		*object_name)		<span class="comment">/* OUT */</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>获取map指向的任务内，address地址起始的VM region（虚拟内存区域）的信息。目前标记为flavor只有<code>VM_BASIC_INFO_64</code>。<br>获得的info的数据结构如下。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">struct vm_region_basic_info_64 &#123;</div><div class="line">	vm_prot_t 	protection<span class="comment">;</span></div><div class="line">	vm_prot_t		max_protection<span class="comment">;</span></div><div class="line">	vm_inherit_t		inheritance<span class="comment">;</span></div><div class="line">	<span class="keyword">boolean_t	</span>	<span class="keyword">shared;</span></div><div class="line">	<span class="keyword">boolean_t	</span>	reserved<span class="comment">;</span></div><div class="line">	memory_object_offset_t	offset<span class="comment">;</span></div><div class="line">	vm_behavior_t		<span class="keyword">behavior;</span></div><div class="line">	unsigned <span class="keyword">short	</span>	user_wired_count<span class="comment">;</span></div><div class="line">&#125;<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<ul>
<li>mach_vm_protect<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span></div><div class="line">mach_vm_protect(</div><div class="line">	<span class="keyword">mach_port_name_t</span> 	task,</div><div class="line">	<span class="keyword">mach_vm_address_t</span> 	address,</div><div class="line">	<span class="keyword">mach_vm_size_t</span> 	size,</div><div class="line">	<span class="keyword">boolean_t</span> 	set_maximum,</div><div class="line">	<span class="keyword">vm_prot_t</span> 	new_protection)</div></pre></td></tr></table></figure>
</li>
</ul>
<p>对address到address+size这一段的内存设置内存保护策略,new_protection就是最后设置成为的保护机制。</p>
<ul>
<li>mach_vm_write<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span></div><div class="line">mach_vm_write(</div><div class="line">	<span class="keyword">vm_map_t</span>		<span class="built_in">map</span>,</div><div class="line">	<span class="keyword">mach_vm_address_t</span>		address,</div><div class="line">	<span class="keyword">pointer_t</span>			data,</div><div class="line">	__unused <span class="keyword">mach_msg_type_number_t</span>	size)</div></pre></td></tr></table></figure>
</li>
</ul>
<p>对address指向的内存改写内容。</p>
<ul>
<li>mach_vm_read<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span> </div><div class="line">mach_vm_read(</div><div class="line">	<span class="keyword">vm_map_t</span> 	target_task, </div><div class="line">	<span class="keyword">mach_vm_address_t</span> 	address, </div><div class="line">	<span class="keyword">mach_vm_size_t</span> 	size, </div><div class="line">	<span class="keyword">vm_offset_t</span> 	*data,   </div><div class="line">	<span class="keyword">mach_msg_type_number_t</span> 	*dataCnt);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>对address指向的内存读取内容.</p>
<h2 id="mach-port"><a href="#mach-port" class="headerlink" title="mach_port_*"></a><code>mach_port_*</code></h2><ul>
<li>mach_port_allocate<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span> </div><div class="line">mach_port_allocate(</div><div class="line">	<span class="keyword">ipc_space_t</span> 	task, </div><div class="line">	<span class="keyword">mach_port_right_t</span> 	right,</div><div class="line">	<span class="keyword">mach_port_name_t</span> 	*name);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>task指要分配端口的任务(<code>mach_task_self()</code>)，right指分配给该端口的权限，name指代分配端口名的地址<br><code>Ports有如下权限，Ports可以在不同的task之间传递，通过传递可以赋予其他task对ports的操作权限。例如POC中使用的就是在父进程与子进程之间传递Port得到了对内存操作的权限。</code><br>    <figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#define MACH_PORT_RIGHT_SEND		((<span class="name">mach_port_right_t</span>) <span class="number">0</span>)</div><div class="line">#define MACH_PORT_RIGHT_RECEIVE		((<span class="name">mach_port_right_t</span>) <span class="number">1</span>)</div><div class="line">#define MACH_PORT_RIGHT_SEND_ONCE	((<span class="name">mach_port_right_t</span>) <span class="number">2</span>)</div><div class="line">#define MACH_PORT_RIGHT_PORT_SET	((<span class="name">mach_port_right_t</span>) <span class="number">3</span>)</div><div class="line">#define MACH_PORT_RIGHT_DEAD_NAME	((<span class="name">mach_port_right_t</span>) <span class="number">4</span>)</div><div class="line">#define MACH_PORT_RIGHT_LABELH	        ((<span class="name">mach_port_right_t</span>) <span class="number">5</span>)</div><div class="line">#define MACH_PORT_RIGHT_NUMBER		((<span class="name">mach_port_right_t</span>) <span class="number">6</span>)</div></pre></td></tr></table></figure></p>
<ul>
<li>mach_port_insert_right<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span> </div><div class="line">mach_port_insert_right(</div><div class="line">	<span class="keyword">ipc_space_t</span>		task, </div><div class="line">	<span class="keyword">mach_port_name_t</span> 		name, </div><div class="line">	<span class="keyword">mach_port_t</span> 		poly, </div><div class="line">	<span class="keyword">mach_msg_type_name_t</span>	 polyPoly);</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/" target="_blank" rel="external">http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/</a></li>
<li><a href="https://developer.apple.com/reference/kernel/1578704-mach_port_allocate" target="_blank" rel="external">https://developer.apple.com</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/vm/">vm</a>, <a href="/tags/macOS内核/">macOS内核</a>, <a href="/tags/mach/">mach</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>

</div></div>
    <aside id="sidebar" class="alignleft"><!-- 
  

  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/BSD/">BSD</a><small>1</small></li>
  
    <li><a href="/tags/C/">C++</a><small>1</small></li>
  
    <li><a href="/tags/Crackme/">Crackme</a><small>1</small></li>
  
    <li><a href="/tags/DLMalloc/">DLMalloc</a><small>1</small></li>
  
    <li><a href="/tags/GOT表/">GOT表</a><small>1</small></li>
  
    <li><a href="/tags/IPC/">IPC</a><small>1</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>9</small></li>
  
    <li><a href="/tags/Protostar/">Protostar</a><small>9</small></li>
  
    <li><a href="/tags/UAF/">UAF</a><small>1</small></li>
  
    <li><a href="/tags/cve/">cve</a><small>1</small></li>
  
    <li><a href="/tags/dyld/">dyld</a><small>1</small></li>
  
    <li><a href="/tags/format/">format</a><small>1</small></li>
  
    <li><a href="/tags/free/">free</a><small>1</small></li>
  
    <li><a href="/tags/gdb/">gdb</a><small>1</small></li>
  
    <li><a href="/tags/heap/">heap</a><small>1</small></li>
  
    <li><a href="/tags/iOS/">iOS</a><small>1</small></li>
  
    <li><a href="/tags/linux/">linux</a><small>2</small></li>
  
    <li><a href="/tags/macOS内核/">macOS内核</a><small>1</small></li>
  
    <li><a href="/tags/mach/">mach</a><small>1</small></li>
  
    <li><a href="/tags/mach-o/">mach-o</a><small>1</small></li>
  
    <li><a href="/tags/macos内核/">macos内核</a><small>1</small></li>
  
    <li><a href="/tags/malloc/">malloc</a><small>1</small></li>
  
    <li><a href="/tags/metadata/">metadata</a><small>1</small></li>
  
    <li><a href="/tags/printf/">printf</a><small>1</small></li>
  
    <li><a href="/tags/strcpy/">strcpy</a><small>1</small></li>
  
    <li><a href="/tags/stub/">stub</a><small>1</small></li>
  
    <li><a href="/tags/vm/">vm</a><small>2</small></li>
  
    <li><a href="/tags/vtable/">vtable</a><small>1</small></li>
  
    <li><a href="/tags/xnu/">xnu</a><small>1</small></li>
  
    <li><a href="/tags/堆溢出/">堆溢出</a><small>4</small></li>
  
    <li><a href="/tags/栈溢出/">栈溢出</a><small>4</small></li>
  
    <li><a href="/tags/看雪/">看雪</a><small>1</small></li>
  
    <li><a href="/tags/调试/">调试</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget twitter">
  <h3 class="title">推文</h3>
  <ul id="tweets"></ul>
</div>

<script type="text/javascript">
var twitter_stream = ['thiagopnts', 5, false];
var moment_js_path = '/js/moment.min.js';
</script>
<script src="/js/twitter.js"></script>


 -->
<div class="personal-info">
  <figure>
    
      <a href="/">
        <img class="personal-photo" src="https://2.gravatar.com/avatar/dfdcc7fdb4b631ae9c30acd5ac6c2cbe?r=x&s=440" alt="4chendy">
      </a>
    
    <figcaption>
      <h3 class=>4chendy</h3>
      <p>Something about you here</p>
    </figcaption>
  </figure>
  <section class="social">
    
      <a target="_blank" class="icon twitter depth" href="http://twitter.com/thiagopnts"></a>
    
    
      <a target="_blank" class="icon facebook depth" href="http://fb.com/your facebook url"></a> 
    
    
      <a target="_blank" class="icon github depth" href="http://github.com/thiagopnts"></a>
    
    
      <a target="_blank" class="icon email depth" href="mailto:email"></a>
    
  </section>
</div>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignright depth">
  <a href="http://github.com/thiagopnts/hexo-persona-dark" style="text-decoration: underline;">Persona Dark Theme</a> 
  &copy; - 2017 4chendy
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>